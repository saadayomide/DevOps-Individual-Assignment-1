name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend-tests:
    name: Backend Tests and Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run ruff linter
        run: |
          cd backend
          ruff check .

      - name: Run mypy type checker
        run: |
          cd backend
          mypy . --ignore-missing-imports || true

      - name: Run bandit security scanner
        run: |
          cd backend
          bandit -r . -ll || true

      - name: Run tests with coverage
        run: |
          cd backend
          pytest --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=70 -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm test -- --ci --coverage --watchAll=false || true

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: |
          cd backend
          docker build -t gov-spending-backend:latest .

      - name: Build frontend image
        run: |
          cd frontend
          docker build -t gov-spending-frontend:latest --build-arg REACT_APP_API_BASE_URL=http://localhost:8000 .

  # Azure deployment via GitHub Actions (Optional)
  # To enable: Uncomment the jobs below and add GitHub secrets (see .azure/CI_CD_DEPLOYMENT_GUIDE.md)
  # Note: For Azure deployments, we recommend using Azure Deployment Center or Azure DevOps Pipelines instead
  
  deploy-backend:
  #   name: Deploy Backend to Azure
  #   runs-on: ubuntu-latest
  #   needs: [docker-build]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Azure Login
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - name: Deploy to Azure App Service (Backend)
  #       uses: azure/webapps-deploy@v3
  #       with:
  #         app-name: ${{ secrets.AZURE_BACKEND_APP_NAME }}
  #         package: ./backend
  #         publish-profile: ${{ secrets.AZURE_BACKEND_PUBLISH_PROFILE }}
  #     - name: Azure logout
  #       run: az logout

  # deploy-frontend:
  #   name: Deploy Frontend to Azure
  #   runs-on: ubuntu-latest
  #   needs: [docker-build]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     - name: Set up Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #     - name: Build frontend
  #       run: |
  #         cd frontend
  #         npm ci
  #         npm run build
  #     - name: Azure Login
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - name: Deploy to Azure App Service (Frontend)
  #       uses: azure/webapps-deploy@v3
  #       with:
  #         app-name: ${{ secrets.AZURE_FRONTEND_APP_NAME }}
  #         package: ./frontend/build
  #         publish-profile: ${{ secrets.AZURE_FRONTEND_PUBLISH_PROFILE }}
  #     - name: Azure logout
  #       run: az logout

