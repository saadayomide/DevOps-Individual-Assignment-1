# Azure DevOps Pipeline for Government Spending Tracker
# This pipeline runs tests, builds, and deploys to Azure App Service

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - .gitignore

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  nodeVersion: '18.x'
  backendAppName: '$(AZURE_BACKEND_APP_NAME)'
  frontendAppName: '$(AZURE_FRONTEND_APP_NAME)'
  resourceGroupName: '$(AZURE_RESOURCE_GROUP)'

stages:
  - stage: Test
    displayName: 'Test and Lint'
    jobs:
      - job: BackendTests
        displayName: 'Backend Tests and Linting'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              cd backend
              pip install -r requirements.txt
            displayName: 'Install backend dependencies'

          - script: |
              cd backend
              ruff check .
            displayName: 'Run ruff linter'
            continueOnError: true

          - script: |
              cd backend
              mypy . --ignore-missing-imports
            displayName: 'Run mypy type checker'
            continueOnError: true

          - script: |
              cd backend
              bandit -r . -ll
            displayName: 'Run bandit security scanner'
            continueOnError: true

          - script: |
              cd backend
              pytest --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=70 -v
            displayName: 'Run tests with coverage'

          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/coverage.xml'
            displayName: 'Publish coverage results'

      - job: FrontendTests
        displayName: 'Frontend Tests'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Use Node.js $(nodeVersion)'

          - script: |
              cd frontend
              npm ci
            displayName: 'Install frontend dependencies'

          - script: |
              cd frontend
              npm test -- --ci --coverage --watchAll=false
            displayName: 'Run frontend tests'
            continueOnError: true

  - stage: Build
    displayName: 'Build Docker Images'
    dependsOn: Test
    jobs:
      - job: BuildImages
        displayName: 'Build Docker Images'
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: '$(DOCKER_REGISTRY_SERVICE_CONNECTION)'
              repository: 'gov-spending-backend'
              command: 'build'
              Dockerfile: 'backend/Dockerfile'
              tags: |
                latest
                $(Build.BuildId)
            displayName: 'Build backend Docker image'

          - task: Docker@2
            inputs:
              containerRegistry: '$(DOCKER_REGISTRY_SERVICE_CONNECTION)'
              repository: 'gov-spending-frontend'
              command: 'build'
              Dockerfile: 'frontend/Dockerfile'
              arguments: '--build-arg REACT_APP_API_BASE_URL=https://$(backendAppName).azurewebsites.net'
              tags: |
                latest
                $(Build.BuildId)
            displayName: 'Build frontend Docker image'

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployBackend
        displayName: 'Deploy Backend to Azure App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    appName: '$(backendAppName)'
                    package: '$(System.DefaultWorkingDirectory)/backend'
                    deploymentMethod: 'auto'
                  displayName: 'Deploy backend to Azure App Service'

      - deployment: DeployFrontend
        displayName: 'Deploy Frontend to Azure App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: NodeTool@0
                  inputs:
                    versionSpec: '$(nodeVersion)'
                  displayName: 'Use Node.js $(nodeVersion)'

                - script: |
                    cd frontend
                    npm ci
                    npm run build
                  displayName: 'Build frontend'

                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    appName: '$(frontendAppName)'
                    package: '$(System.DefaultWorkingDirectory)/frontend/build'
                    deploymentMethod: 'auto'
                  displayName: 'Deploy frontend to Azure App Service'

